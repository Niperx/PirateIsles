# PirateIsles — .todo
# Смысл игры, что реализовано, что планируется менять и дополнять

---

## Суть игры

**PirateIsles** — браузерная idle PvPvE стратегия в пиратском сеттинге: топ-даун моря, острова, корабли.

- Игрок развивает свой остров (таверна, dok, пушки), собирает ресурсы (ром, золото, дерево), строит лодки, отправляет их в PvE-рейды и на ресурсные острова, может атаковать других игроков (PvP). Есть оффлайн-прогресс, щит после атаки, стадии разрушения острова и legacy-бонус.
- В перспективе — ручное управление кораблём (WASD) в отдельном приложении (Captain Mode).

Цель MVP: играбельный остров, idle-рейды, оффлайн-прогресс, базовый PvP с защитой. Это достигнуто.

---

## Что уже реализовано

- Логин (ник + опциональный пароль), guest-режим.
- Остров игрока: уровни, постройки (таверна, dok, пушки, остров), визуал (эллипс, placeholder-здания), щит-купол, стадии разрушения (нормальный / повреждённый / разрушенный).
- Ресурсы: ром (пассивный доход от таверны), золото, дерево; отображение в HUD и в панели построек.
- Рейды: AI-рейд (кнопка, таймер, анимация лодки в 3 фазы, возврат только при успехе); рейды на архипелаг (островки у базы, клик → отправка лодки, деплеция, лут); рейды на ресурсные острова на мировой карте (клик по острову, таймер, лут, деплеция, персистентность в Redis).
- PvP: список игроков, атака (летящая миссия), кража ресурсов, щит 4–8 ч, debris (сбор золота), legacy-бонус.
- **PvP v2:** выбор флота 1–5 лодок (ограничен доком и доступными лодками); симуляция боя (attackPower vs defensePower → % выживших → три исхода: victory / pyrrhic / defeat); активная оборона — при входящей атаке модалка с таймером 25 сек и 3 вариантами (залп пушек / усилить щит / наёмники); `incomingAttack` → `activeDefenseChoice` → модификаторы в `resolvePvpAttack`.
- Мировая карта: переключение вид база/мир, камера, миникарта, ресурсные острова, PvP-миссии, точки захвата, караваны; кнопка «Вернуться на базу».
- **Точки захвата PvP:** 8 нейтральных точек на мировой карте; свободную можно захватить (1–3 лодки, таймер ~3 мин / лодка); занятую можно перехватить — Fleet vs Fleet, победитель продолжает захват; по завершении лут (gold+rum), респаун 8 мин.
- **Имперские караваны:** 4 движущихся NPC по маршруту-петле (тик 10 сек); перехват — выбор 1–5 лодок, погоня 2–5 мин, затем Fleet vs NPC (эскорт 3 «лодки»); повышенный лут (gold, rum); риск потери лодок. **Конкуренция:** если караван уже перехватывает другой игрок — новый перехватчик вступает в Fleet vs Fleet с текущим владельцем; победитель продолжает перехват каравана, проигравший теряет часть лодок и получает сообщение в чат.
- Оффлайн-прогресс: при логине модалка с временем отсутствия и полученным ромом (и деревом от архипелага).
- Вода: переливающийся градиент + тайл ряби (ripples.png) с параллаксом.
- Ассеты: папка `assets/` (sea, ui, sprites, fonts, audio); структура по `assets/README.md`; используются ripples.png, island1.png и др.
- Docker: образ с копированием `assets/`, volume для `./assets` в docker-compose.
- UI: тосты (успех/ошибка/info), панель рейдов с группировкой (PvE, архипелаг, ресурсные острова, перехват караванов) и сортировкой по ETA, звуки (волны, монета, отправка лодки), i18n RU/EN.
- **Лодки:** док только увеличивает лимит; лодки строятся отдельно за дерево (`buyBoat`, 80 дерева). В HUD и панели построек отображаются: свободно / в рейдах / лимит (tooltip и строка «Свободно: N · В рейдах: M · Лимит: K»). Потеря лодки в рейде не перманентна — можно построить замену.
- **Анимация PvE-рейда:** лодка отплывает от края острова в случайном направлении, исчезает через 5 сек, появляется и возвращается только при успехе (за 5 сек до зачисления); при потере — не возвращается визуально.

---

## Что планируется в дальнейшем

### Доработки и улучшения
- Заменить placeholder-графику на спрайты из `assets/` (острова, постройки, корабли, эффекты) по README.
- При желании — рефакторинг фронта: вынос JS/CSS в отдельные файлы (main.js, render.js и т.д.) после стабилизации MVP.
- Расширить чат (сейчас простой глобальный лог) до полноценной системы при необходимости.
- Улучшать баланс и подбирать параметры (время рейдов, луты, проценты кражи, оффлайн, стоимость лодки) — всё правится на сервере.
- Добавить анимацию лодки для рейдов на архипелаг (сейчас только прогресс-бар без визуала лодки).

### Новый контент и механики (по приоритету / по желанию)

#### PvP — уже реализовано (см. «Что уже реализовано»)
- Флот 1–5 лодок, симуляция боя (victory/pyrrhic/defeat), активная оборона (модалка cannon/shield/mercenary) — сделано.
- Точки захвата (8 точек, launchCapture/launchIntercept, Fleet vs Fleet) — сделано.
- Имперские караваны (движение по маршруту, перехват 2–5 мин, Fleet vs NPC, конкуренция: перехват перехватчика — Fleet vs Fleet за право вести миссию) — сделано.

#### Конкуренция за ресурсы (планы)
- **Архипелаг с захватом и перехватом:** текущий рейд на архипелаг — одиночный PvE. Превратить в PvP-зону: игроки видят кто захватывает → могут перехватить → Fleet vs Fleet бой (20–40 сек симуляция). Прогресс-бар виден всем. Победитель продолжает захват, проигравший теряет 40–60% лодок + debris.
- **Острова с сокровищами:** редкие точки, респаун 4–8 ч, таймер захвата 6–10 мин, лут ×2–4. Конкуренция между игроками (видно кто захватывает). Бонусный множитель если объект был оспорен.
- **Враждебные NPC-пираты:** движение по карте, атака слабых островов (при cannon_level = 0 или низком), лут при победе.

#### UI и визуал
- **Замена placeholder-графики** на нормальные спрайты: флоты, пушки, взрывы, щит (ПРИОРИТЕТ 1).
- **Визуализация перехватов на карте** — дополнительные «дротики» для PvP-перехватов (ПРИОРИТЕТ 2).
- **Лидерборд:** по успешным атакам / оборонам / захваченным сокровищам (ПРИОРИТЕТ 5).

#### Прочее
- **Кланы:** объединение игроков, помощь при захвате / обороне (позже).
- **События, косметика, аудио (BGM), push-уведомления** — по необходимости.

### Captain Mode (отдельное приложение)
- Решение: отдельный standalone (например captain.html или отдельный репозиторий), общий бэкенд и Redis.
- Управление кораблём в реальном времени (WASD), синхронизация ресурсов и прогресса с основной idle-игрой.
- Начинать после стабилизации idle-core.

### Возможные изменения и упрощения
- Убрать или упростить редко используемые механики, если перегружают баланс или UI.
- Переименовать/унифицировать термины (например gold vs дублоны) в UI и текстах.
- Документировать контракты socket.io и Redis при добавлении новых событий или ключей.

---

## Технические заметки (для планов)

- **Redis:** при добавлении новых ключей или форматов (игроки, острова, караваны и т.д.) обновлять описание схемы (сейчас кратко в .agent, детали можно перенести сюда или в отдельный doc).
- **Баланс:** все числа и формулы — на сервере; клиент только отображает. При изменении формул оффлайна, кражи, debris, стоимости лодки и т.д. обновлять константы в server.js и при необходимости .todo/.agent.
- **Ассеты:** именование и структура — по `assets/README.md`; при добавлении новых файлов соблюдать snake_case и описанную структуру папок.
- **Константы лодок:** `BOAT_BUILD_COST` в server.js и в index.html (секция balance constants) должны совпадать — менять синхронно.

---

*Файл .todo обновлять по мере реализации пунктов и появления новых планов.*
