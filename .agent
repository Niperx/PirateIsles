# PirateIsles — .agent (для агента)
# Кратко: что есть в игре и как реализовано. Что править/улучшать — см. .todo

## Стек и структура
- **Фронт:** один `index.html` (inline CSS + JS), Canvas 2D.
- **Бэкенд:** `server.js` — Express, socket.io, Redis (ioredis).
- **Запуск:** `node server.js` или Docker (`docker-compose up`). Статика: `express.static` для корня и `app.use('/assets', express.static(path.join(__dirname, 'assets')))`.
- **Ассеты:** папка `assets/` (см. `assets/README.md`). В коде используются: `assets/sea/ripples.png`, `assets/sprites/islands/island1.png` (и др. по README).

## Что реализовано в коде

### Клиент (index.html)
- Логин: ник + опциональный пароль, guest, сохранение в localStorage.
- HUD: ром, золото, дерево, лодки, щит; панели: постройки, рейды (с группировкой PvE/архипелаг/ресурсные острова, сортировка по ETA), список игроков.
- Canvas: два режима — база (свой остров + архипелаг) и мировая карта (острова игроков, ресурсные острова, PvP-миссии). Переключение кнопкой; кнопка «Вернуться на базу» в world mode.
- Вода: переливающийся градиент + тайл `ripples.png` с параллаксом по камере и времени.
- Остров: свой — эллипс, постройки (таверна, док, пушки), лодки у дока, щит-купол, стадии разрушения; архипелаг — островки у базы, клик → рейд на островок.
- Ресурсные острова: на мировой карте, клик → отправка лодки; отрисовка маршрута пунктиром и лодок в пути.
- PvP: список игроков, кнопка рейда, летящие «дротики» к цели; щит после атаки.
- Рейды: AI-рейд (кнопка «Отправить лодку»), рейды на архипелаг, рейды на ресурсные острова; панель рейдов с прогресс-барами и таймерами.
- Тосты: успех/ошибка/info, авто-закрытие ~5.5 с.
- Звуки (Web Audio): волны (loop), монета при луте, звук отправки лодки; инициализация при первом клике (логин).
- i18n: RU/EN, переключатель, строки в `STRINGS`, `data-i18n`, `t(key, ...args)`.

### Сервер (server.js)
- Игроки: создание/вход по нику и паролю, оффлайн-прогресс при логине (ром, дерево от архипелага).
- Ресурсы и постройки: rum, gold, wood; таверна, док, пушки, остров; расчёт стоимости и лимитов (boatCapacity, tavernCost и т.д.).
- Рейды: AI-рейд (activeRaids), рейды на архипелаг (archi_raids, archi_depleted), рейды на ресурсные острова (resource_raids); тик RAID_CHECK_TICK — завершение, лут, деплеция, события raidResult, archiResult, resourceRaidResult.
- Ресурсные острова: generateResourceIslands(), хранение в Redis (ключ `resourceIslands`, JSON); при старте — загрузка из Redis или генерация + сохранение; при деплеции — обновление depleted_until и запись в Redis.
- PvP: attackPlayer → полёт миссии (pvpMissions), resolvePvpAttack — кража, щит, destruction_state, debris, legacy_bonus.
- Redis: player:<id>, player:<id>:resources, :cooldowns, :destruction_state, :debris, :legacy_bonus; players:nicks; resourceIslands. Автосейв игроков раз в 20 с.

### Docker
- `Dockerfile`: копирует package.json, server.js, index.html, `assets/`. `docker-compose.yml`: монтирует `./server.js`, `./index.html`, `./assets` в контейнер.

## Где что искать
- Рендер воды: в index.html функция `drawWater(W, H)`.
- Рендер острова, построек, архипелага, ресурсных островов, PvP-миссий: функции `draw*` в index.html после `drawWater`.
- События socket.io: в index.html — `socket.on('state', ...)`, `socket.on('raidsUpdate', ...)`, `socket.on('resourceRaidResult', ...)` и др.; в server.js — `socket.on('join', ...)`, `socket.on('upgradeTavern', ...)`, `socket.on('harvestResourceIsland', ...)` и др.
- Баланс: константы в начале server.js (TICK_RATE, RAID_*, PVP_*, RESOURCE_*, ARCHI_* и т.д.).
- Схема Redis: в .agent был раздел 4; при изменении ключей обновлять описание (сейчас можно вынести в .todo или оставить кратко здесь).

## Ограничения и соглашения
- Один index.html — без разбиения на отдельные JS/CSS файлы (до рефакторинга).
- Баланс и валидация — на сервере; клиент только отображает присланные значения.
- Ассеты подключать через путь относительно страницы, например `assets/sea/ripples.png`.

Планы, идеи, что делать дальше — в **.todo**.
