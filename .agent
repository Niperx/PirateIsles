# PirateIsles — .agent file (версия 7.0 — февраль 2026)
# Браузерная PvPvE idle-стратегия с элементами ручного управления кораблём (WASD)
# Основа: один HTML-файл + Canvas 2D + vanilla JS + Node.js + socket.io + Redis
# Цель: MVP → playable остров + idle-рейды + оффлайн-прогресс + базовый PvP с защитой
#
# Этот файл описывает:
# - что ЗАДУМАНО (дизайн),
# - что УЖЕ СДЕЛАНО в текущем коде,
# - что ЕЩЁ НЕ РЕАЛИЗОВАНО и оставлено на будущее.

## 1. Общая концепция
Название: PirateIsles
Жанр: Hybrid idle PvPvE + arcade (WASD-корабль опционально)
Сеттинг: Топ-даун пиратские моря, procedural острова, анимированная вода (pixel art)
Доступность: ПК (WASD + мышь) + мобилька (тач/виртуальный джойстик)

Техстек (MVP):
- Frontend: строго один index.html (всё внутри <script> и <style>)
  - СТАТУС: СДЕЛАНО. В проекте один `index.html` с inline CSS/JS.
- Графика: Canvas 2D, placeholder'ы (прямоугольники, текст, простые формы) — спрайты добавлю позже
  - СТАТУС: СДЕЛАНО. Остров, здания, лодки, щит, разрушение и вода — все отрисованы примитивами Canvas 2D.
- Анимированная вода (pixel art / процедурная)
  - СТАТУС: СДЕЛАНО. Кастомная вода на Canvas 2D с 2D Simplex Noise и линиями пены по гребням волн.
- Backend: Node.js + socket.io (v4+) + socket.io-redis adapter
  - СТАТУС: ПРЕДПОЛОЖИТЕЛЬНО СДЕЛАНО (по зависимостям и протоколу событий), но внутренняя реализация не описана здесь.
- Хранение: Redis (standalone, без модулей на старте)
  - СТАТУС: ЗАДУМАНО И ИСПОЛЬЗУЕТСЯ СЕРВЕРОМ (см. схему в разделе 4), детали реализации на стороне Node.
- Связь: socket.io (WebSocket + polling fallback)
  - СТАТУС: СДЕЛАНО. Клиент подключается через `io()` и обменивается состоянием/событиями.

## 2. Механики (MVP-фокус)

### 2.1. База (Остров)
- Простая procedural генерация (центральный остров + несколько мелких)
  - СТАТУС: ЧАСТИЧНО. Есть один центральный остров игрока (размер зависит от уровня).
  - НА БУДУЩЕЕ: добавить генерацию мелких островков вокруг (архипелаг) на Canvas 2D.
- Апгрейды: таверна (пассивный ром), док (больше лодок), пушки (оборона)
  - СТАТУС: СДЕЛАНО.
    - Таверна, док, пушки, уровень острова — есть UI-кнопки, расчёт стоимости, связи с сервером.
    - Таверна влияет на пассивный доход рома, док — на лимит лодок, пушки — на оборону (визуально и логически на сервере).

### 2.2. Ресурсы
- Ром: основной пассивный доход
  - СТАТУС: СДЕЛАНО. Клиент считает и показывает `Rum/sec`, учитывая уровни таверны и legacy-бонус.
- Дублоны (gold): валюта для апгрейдов
  - СТАТУС: СДЕЛАНО. В UI и коде фигурирует как `Gold`; используется в наградах рейдов и PvP.
- Дерево: строительство
  - СТАТУС: СДЕЛАНО. Ресурс `wood` отображается и тратится на апгрейды.

### 2.3. Idle-режим (AI-лодки)
- Отправка лодок на PvE-рейды (таймер 8–20 мин)
  - СТАТУС: СДЕЛАНО (клиентская часть). Есть кнопка «Send Boat on Raid» / «Отправить лодку в рейд», список активных рейдов с прогрессом и таймерами.
  - ПАРАМЕТРЫ ВРЕМЕНИ: диапазон 8–20 минут и точный рандом реализуются на сервере (клиент показывает полученное).
- Возврат с лутом + шанс потери лодки
  - СТАТУС: СДЕЛАНО. Есть событие `raidResult`: либо возврат с ресурсами, либо потеря лодки; игрок информируется через тосты.
- Оффлайн-накопление: 40% от онлайн-скорости, max 12 часов
  - СТАТУС: СДЕЛАНО (по протоколу). При логине сервер отдаёт `offlineGains`, клиент показывает модалку с временем и количеством рома.
  - НА БУДУЩЕЕ: при изменении формулы/лимитов — документировать это здесь и в контракте событий.

### 2.4. PvP (базовый + защита)
- Атака другого игрока → кража 45–65% доступных ресурсов
  - СТАТУС: СДЕЛАНО (механика). В списке игроков есть кнопка рейда; при успехе тост показывает украденные ресурсы.
  - ПРОЦЕНТЫ 45–65% закреплены на сервере; клиент их не хардкодит.
- После атаки: авто-щит 4–8 часов
  - СТАТУС: СДЕЛАНО. Сервер выставляет `shield_until`, клиент показывает иконку/надпись щита и визуальный купол над островом.
- Debris Field: 40% от украденного → обломки (рециклинг)
  - СТАТУС: СДЕЛАНО. У игрока есть `debris_gold`; под островом текст «Обломки: N золота (сбор...)».
  - Доли 70/30 (атакующий/защитник) реализуются сервером.
- Стадии разрушения: нормальная → повреждённая → разрушенная
  - СТАТУС: СДЕЛАНО. `destruction_state` (0..2) влияет на цвет острова, трещины и дымовую/частичную анимацию.
- Legacy: +1% доход за каждый разрушенный уровень (при wipe)
  - СТАТУС: ЧАСТИЧНО СДЕЛАНО.
    - В клиенте есть `legacy_bonus`, учитывается в формуле дохода и отображается в UI.
    - Конкретный механизм накопления через wipe реализуется на сервере (здесь не детализирован).

### 2.5. Аутентификация
- Ник + опциональный пароль
  - СТАТУС: СДЕЛАНО. В форме логина два поля; логика на стороне сервера, клиент отправляет `nick` + `password`.
- Если ник занят и пароль задан → требует пароль
  - СТАТУС: СДЕЛАНО (через ответы сервера). При ошибке показывается текст в `login-error`.
- Guest-режим: если пароль не задан — пускает сразу
  - СТАТУС: СДЕЛАНО (по контракту). Пустой пароль трактуется как guest.

## 3. Баланс-ориентиры (MVP)
- Начальный ром: 2 / сек
  - СТАТУС: СДЕЛАНО. Клиент использует BASE_RUM = 2.
- Апгрейд таверны lvl 1 → 2: 400 ром → +1 / сек
  - СТАТУС: СДЕЛАНО. Стоимость апгрейда таверны уровней считается с базой 400 и множителем.
- Каждый следующий апгрейд: ×2 от предыдущей цены
  - СТАТУС: СДЕЛАНО (для ключевых построек). В клиенте используется COST_MULT = 2.
- AI-рейд: 8–20 мин, лут 150–1200 ром (среднее 500)
  - СТАТУС: ПАРАМЕТРЫ НА СЕРВЕРЕ. Клиент только показывает `duration` и результат лута.
- Риск потери лодки: 12% базово
  - СТАТУС: ПАРАМЕТР НА СЕРВЕРЕ. Клиент обрабатывает только факт потери.
- PvP-кража: 45–65% доступного
  - СТАТУС: ПАРАМЕТРЫ НА СЕРВЕРЕ. Клиент показывает уже посчитанные украденные значения.
- Debris: 40% от украденного (атакующий 70%, защитник 30% пассивно)
  - СТАТУС: ПАРАМЕТРЫ НА СЕРВЕРЕ. Клиент показывает `debris_gold` и описательный текст.
- Оффлайн лимит: 12 часов
  - СТАТУС: ПАРАМЕТР НА СЕРВЕРЕ. Клиент отображает только присланные `offlineGains`.
- Авто-ремонт: +1.5% уровня острова в час (нужен ром)
  - СТАТУС: ПАРАМЕТР НА СЕРВЕРЕ. В клиенте визуально отражается только текущий `destruction_state`.

## 4. Persistence (Redis схема)
player:<id> → {nick, island_level, pos_x, pos_y, last_active}
player:<id>:resources → {rum: number, gold: number, wood: number}
player:<id>:cooldowns → {raid: timestamp, sail_out: timestamp}
player:<id>:destruction_state → 0..2
player:<id>:debris → {gold: number, ttl: timestamp}
player:<id>:legacy_bonus → number (процент дохода)

Автосейв: каждые 20 сек delta по socket.io

СТАТУС:
- Схема используется сервером (по полям, которые приходят в `state` и других событиях).
- Этот файл описывает целевую форму данных; при изменении Redis-структуры нужно обновлять и эту секцию.

## 5. TODO по фазам (MVP)

Phase 0: Setup
- index.html с canvas
- socket.io клиент + подключение к серверу
- Базовый UI (ресурсы, кнопки)

СТАТУС: Phase 0 ЗАВЕРШЕНА.

Phase 1: Core Idle
- Остров (прямоугольник + текст)
- Пассивный доход рома
- Отправка AI-лодок (таймер + возврат)
- Оффлайн-прогресс при логине
- Простой PvP-атака (кража ресурсов + debris)

СТАТУС: Phase 1 В ОСНОВНОМ СДЕЛАНА на уровне фронтенда и протокола:
- Есть остров игрока с уровнями и визуалом.
- Пассивный доход рома считается и отображается.
- AI-рейды, возврат с лутом и шанс потери лодки реализованы.
- Оффлайн-прогресс показывается при логине.
- Базовый PvP (атака, кража, debris, щит, разрушение, legacy) работает.

Отложить после MVP:
- WASD-корабль
- Кланы, чат, события, косметика, аудио, push

СТАТУС:
- WASD-корабль: ЕЩЁ НЕ РЕАЛИЗОВАН. Нужен отдельный контроллер и логика боя/управления.
- Кланы: ЕЩЁ НЕ РЕАЛИЗОВАНО.
- Чат: БАЗОВО СДЕЛАНО (простой глобальный лог сообщений через socket.io), но не развит до полноценной системы.
- События, косметика, аудио, push: ЕЩЁ НЕ РЕАЛИЗОВАНО.

## 6. Инструкции для разработчика (Claude)

- На старте: строго один index.html (JS/CSS внутри)
- После MVP: подготовь план рефакторинга на модули (main.js, render.js и т.д.)
- Ассеты: используй placeholder'ы (ctx.fillRect, ctx.fillText, простые круги/треугольники для кораблей)
- Сервер: Node.js + socket.io + socket.io-redis
- Redis: валидация всех действий на сервере (анти-чит)
- Выдавай код по частям: сначала сервер, потом клиент, с объяснениями
- Добавляй комментарии // TODO и console.log для дебага

ДОП. КОММЕНТАРИИ ПО СОСТОЯНИЮ:
- Ограничение «один index.html» соблюдено; после стабилизации MVP планируется вынос в отдельные модули.
- Placeholder-графика активно используется, что упрощает последующую замену на спрайты.
- Клиент не дублирует серверный баланс, а опирается на присылаемые значения (проценты кражи, оффлайн-коэффициенты и т.п.), что позволяет править баланс на стороне сервера без правок фронта.